# Example code for testing and development
# Not a good idea to run all at once, run line by line 

```{r libraries, echo=FALSE,message=FALSE,warning=FALSE,results='asis'}
library(PPforest)
library(PPtree)
library(reshape)
library(plyr)
library(ggplot2)
library(randomForest)
library(lineprof)
library(profr)
library(PPtree)
library(rpart)
library(randomForest)
library(xtable)

```

```{r data,echo=FALSE,cache=TRUE,message=FALSE,warning=FALSE,results='asis'}
#IRIS data example
data.iris <- iris[ ,5:1]
training <- train_fn(iris[,5],.9)
#test <- as.vector(1:length(iris[,5]))[!(1:length(iris[,5])%in%(training))]

result.boot.st <- mlply(data.frame(nt=c(5, 10, 50, 100, 500)), 
        function(nt) {
          bootstrap_pp(data=data.iris, 
            scale=TRUE, size.p=.9, training=NULL, test=NULL, 
            strata=TRUE, ntree=nt, index="LDA") 
        }  
)  

result.bagg.st <- llply(result.boot.st[1:5], function(x) 
  bagging_pp(data=data.iris, scale=TRUE, strata=TRUE, boot=x, training=NULL))

error.st <- sapply(result.bagg.st,function(x) x[[1]][1] )

```

```{r table.res, echo=FALSE, dependson='data', results='asis'}
aux <- c(5,10,50,100,500)

aaa <- xtable(cbind(aux,error.st), digits=5, caption="OOB error for PP.bagging with bootstrap samples without strata and with strata")

print(aaa, caption.placement="top", include.rownames=TRUE, include.colnames=TRUE)
```

Using PPtree with LDA the error is 0

```{r pp.iris,dependson='data',echo=TRUE,message=FALSE,warning=FALSE}
Tree.result <- PP.Tree("LDA", iris[training,5], iris[training,1:4])
test <- iris[-training,]
res <- PP.classify(test[,1:4], test[,5], Tree.result,1)
print(res[[1]]/length(res[[2]]))
```

Using the same data we run a random forest and the oob error is around 5%.

```{r rf.iris,depenson="data'",echo=FALSE,message=FALSE,warning=FALSE}
rf.iris <- randomForest(Species ~ ., data=iris[training,], importance=TRUE,
                     proximity=TRUE, strata=Species)
print(rf.iris)
```

### OLIVE DATA

```{r olive,cache=TRUE,echo=FALSE,results='asis',message=FALSE,warning=FALSE}
load("./data/olive.rda")

d.olive2 <- subset(d.olive, Region%in%c(1,2))[,-2]
d.olive2$Region <- factor(d.olive2$Region)

training <- train_fn(d.olive2[,1], .9)

boot <- bootstrap_pp(data=d.olive2, training=training, ntree=50, index="LDA") 
b.pp <- bagging_pp(d.olive2, scale=TRUE, strata=TRUE, boot, training)

result.boot2.st <- mlply(data.frame(nt=c(5,10,50,100,500)), function(nt) {
  bootstrap_pp(data=d.olive2, scale=TRUE, size.p=.9, training=training, 
               strata=TRUE, ntree=nt,index="LDA") 
   }  
)  

result.bagg2.st <- llply(result.boot2.st[1:5], function(x) 
  bagging_pp(data=d.olive2, scale=TRUE, strata=TRUE, boot=x, training=training))

error.st <- sapply(result.bagg2.st, function(x) x[[1]][1] )
```

```{r table.olive,echo=FALSE,dependson='olive',results='asis',message=FALSE,warning=FALSE}
aux <- c(5,10,50,100,500)

aaa <- xtable(cbind(aux, error.st), digits=5, caption="OOB error for PP.bagging with bootstrap samples without strata and with strata")
###
print(aaa, caption.placement="top", include.rownames=TRUE, include.colnames=TRUE)
```

```{r pp.olive,dependson='olive',cache=TRUE,echo=FALSE}
Tree.result <-  LDA.Tree(d.olive2[training,1], d.olive2[training, 2:9])

test <- d.olive2[-training,]
res <- PP.classify(d.olive2[training,2:9], d.olive2[training,1], Tree.result, 1)

print(res[[1]]/length(res[[2]]))
```

Using random forest the OOb error us 0\%

```{r rf.olive,dependson='olive',cache=TRUE,echo=FALSE}
rf <- randomForest(Region ~ ., data=d.olive2[training,], importance=TRUE, strata=Region,
             proximity=TRUE)
print(rf)
```


Basic Output of PPforest for ntree=50

```{r olive2,depenson='olive',cache=TRUE,echo=FALSE}
boot <- bootstrap_pp(data=d.olive2, training=training, ntree=50, index="LDA") 
b.pp <- bagging_pp(d.olive2, scale=TRUE, strata=TRUE, boot, training)
```

```{r data.cv,cache=TRUE,echo=FALSE}
crab.aux <- read.csv("./data/australian-crabs.csv", header=T)[,-3]
crab <- data.frame(Type=with(crab.aux, paste(species, sex, sep="")), crab.aux[,-c(1,2)])
leukemia <- read.csv( "./data/Leuk-tot.csv",header=T)
lymphoma <- read.csv("./data/Lymp-tot.csv",header=T)
NCI60 <- read.csv("./data/NCI60.csv",header=T)
wine <- read.csv( "./data/wine.csv", header=T)
glass <- read.csv("./data/glass.csv", header=T)
fishcatch <- read.csv("./data/fishcatch.csv", header=T)[,-1]
names(fishcatch)[1] <- "Type"
image <- read.csv("./data/image.csv",header=T  )
parkinson <- read.csv("./data/parkinsons.csv",header=T)

#temp = list.files(pattern="*.csv")
#myfiles = lapply(temp, read.delim)
```

```{r datapp,cache=TRUE,echo=FALSE,dependson="data.cv"}
#################Leukemia####################
training.leuk <- train_fn(leukemia[,1], .9)

result.boot.leuk <- mlply(data.frame(nt=c(5,10,50,100,500)), 
  function(nt) {
    bootstrap_pp(data=leukemia, scale=TRUE, size.p=.9, 
                training=training.leuk,strata=TRUE, ntree=nt, index="LDA") 
   }  
)  

result.bagg.leuk <- llply(result.boot.leuk, function(x) 
  bagging_pp(data=leukemia, scale=TRUE, strata=TRUE, boot=x, training=training.leuk))

error.leuk <- sapply(result.bagg.leuk, function(x) x[[1]][1] )

aux <- c(5,10,50,100,500)

aaa.leuk<-xtable(cbind(aux,error.leuk),digits=5,caption="OOB error for PP.bagging with bootstrap samples with strata ")
###
print(aaa.leuk,caption.placement="top",include.rownames=TRUE,include.colnames=TRUE)

################NCI60###################

training.nci60 <- train_fn(NCI60[,1], .9)
output<-bootstrap_pp(NCI60,scale=TRUE,size.p=.9,training=training.nci60,strata=TRUE,ntree=50,index="LDA") 
 b.pp <- bagging_pp(NCI60,scale=TRUE, strata=TRUE,output,training=NULL,test=NULL)
 b.pp[[1]]

output.pda<-bootstrap_pp(NCI60,scale=TRUE,size.p=.9,training=training.nci60,strata=TRUE,ntree=50,index="PDA",lambda=.14) 
 b.pp <- bagging_pp(NCI60,scale=TRUE, strata=TRUE,output,training=NULL,test=NULL)
 b.pp[[1]]


result.boot.nci60 <- mlply(data.frame(nt=c(5,10,50,100,500)), 
  function(nt) {
    bootstrap_pp(data=NCI60, scale=TRUE, size.p=.9, training=training.nci60,strata=TRUE, ntree=nt, index="PDA",lambda=.14) 
   }  
)  

result.bagg.nci60 <- llply(result.boot.nci60, function(x) 
  bagging_pp(data=NCI60, scale=TRUE, strata=TRUE, boot=x, training=training.nci60))

error.nci60 <- sapply(result.bagg.nci60, function(x) x[[1]][1] )

aux <- c(5,10,50,100,500)

aaa.nci60<-xtable(cbind(aux,error.nci60),digits=5,caption="OOB error for PP.bagging with bootstrap samples with strata ")
###
print(aaa.nci60,caption.placement="top",include.rownames=TRUE,include.colnames=TRUE)

###########################
training.leuk <- train_fn(leukemia[,1], .9)

result.boot.leuk <- mlply(data.frame(nt=c(5,10,50,100,500)), 
  function(nt) {
    bootstrap_pp(data=leukemia, scale=TRUE, size.p=.9, 
                training=training.leuk,strata=TRUE, ntree=nt, index="LDA") 
   }  
)  

result.bagg.leuk <- llply(result.boot.leuk, function(x) 
  bagging_pp(data=leukemia, scale=TRUE, strata=TRUE, boot=x, training=training.leuk))

error.leuk <- sapply(result.bagg.leuk, function(x) x[[1]][1] )

aux <- c(5,10,50,100,500)

aaa.leuk<-xtable(cbind(aux,error.leuk),digits=5,caption="OOB error for PP.bagging with bootstrap samples with strata ")
###
print(aaa.leuk,caption.placement="top",include.rownames=TRUE,include.colnames=TRUE)

#######################wine

training.wine <- train_fn(wine[,1], .9)

result.boot.wine<- mlply(data.frame(nt=c(5,10,50,100,500)), 
  function(nt) {
    bootstrap_pp(data=wine, scale=TRUE, size.p=.9, 
                training=training.wine,strata=TRUE, ntree=nt, index="LDA") 
   }  
)  

result.bagg.wine <- llply(result.boot.wine, function(x) 
  bagging_pp(data=wine, scale=TRUE, strata=TRUE, boot=x, training=training.wine))

error.wine <- sapply(result.bagg.wine, function(x) x[[1]][1] )

aux <- c(5,10,50,100,500)

aaa.wine<-xtable(cbind(aux,error.wine),digits=5,caption="OOB error for PP.bagging with bootstrap samples with strata ")
###
print(aaa.wine,caption.placement="top",include.rownames=TRUE,include.colnames=TRUE)




```

# Cross validation
```{r cv,dependson="data.cv",cache=TRUE,echo=FALSE}
#PPtree
lda.err <- function(tr,te){
ppt.lda <- LDA.Tree(tr[,1],tr[,-1])

ppt.pred.tr <- PP.classify(tr[,-1], tr[,1],ppt.lda , Rule=1)

ppt.pred.te <- PP.classify(te[,-1], te[,1],ppt.lda , Rule=1)

err.tr <- ppt.pred.tr[[1]]/length(ppt.pred.tr[[2]])

err.te <- ppt.pred.te[[1]]/length(ppt.pred.te[[2]])
data.frame(err.tr,err.te)
}

#PPtree
pda.err <- function(tr,te){
ppt.pda <- PDA.Tree(tr[,1],tr[,-1],lambda=.14)

ppt.pred.tr <- PP.classify(tr[,-1], tr[,1], ppt.pda, Rule=1)
ppt.pred.te <- PP.classify(te[,-1], te[,1], ppt.pda, Rule=1)

err.tr <- ppt.pred.tr[[1]]/length(ppt.pred.tr[[2]])
err.te <- ppt.pred.te[[1]]/length(ppt.pred.te[[2]])
data.frame(err.tr,err.te)
}

#CART
cart.err <- function(tr,te){
cart <- rpart(as.factor(Type)~., data=tr)
fit.preds.tr <- predict(cart, newdata=tr, type="class")
fit.preds.te <- predict(cart, newdata=te, type="class")
fit.table.tr <- table(tr[,1], fit.preds.tr)
fit.table.te <- table(te[,1], fit.preds.te)
err.tr <- (dim(tr)[1]-sum(diag(fit.table.tr)))/dim(tr)[1]
err.te <- (dim(te)[1]-sum(diag(fit.table.te)))/dim(te)[1]
data.frame(err.tr, err.te)
}

#RF
rf.err <- function(tr,te) {
rf <- randomForest(as.factor(Type) ~ ., data=tr)
err.tr <- (dim(tr)[1]-sum(diag(rf$confusion[,-dim(rf$confusion)[2]])))/dim(tr)[1]
fit.preds.te <- predict(rf,newdata=te,type="class")
fit.table.te <- table(te[,1],fit.preds.te)
err.te <- (dim(te)[1]-sum(diag(fit.table.te)))/dim(te)[1]
data.frame(err.tr,err.te)
}

#PP.RF
pprf.err <- function(data, tr, te, tr.index, te.index, lambda=0.14, strata=TRUE, 
    index="LDA") {
  bo.pp <- bootstrap_pp(data=data, scale=TRUE, size.p=.9, training=tr.index, 
                        strata=strata,ntree=5,index=index,lambda=0.14)      
  ba.pp <- bagging_pp(data, scale=TRUE, strata=strata, bo.pp, tr=tr.index, te=te.index)
  data.frame(ba.pp[[2]], ba.pp[[3]])
}

cv.meth <- function(data) {
 rdply(2, function() {
  tr.index <- train_fn(data[,1], 2/3)
  te.index <- as.vector(1:length(data[,1]))[!(1:length(data[,1])%in%(tr.index))]
  training <- data[tr.index,]
  test <- data[-tr.index,] 
  data.frame(lda=lda.err(training,test), cart=cart.err(training,test), 
             rf=rf.err(training,test), 
             pprf=pprf.err(data,training, test, tr.index, te.index)) 
  })
}
```

```{r}
data <- leukemia

tr.index <- train_fn(data[,1], 2/3)
te.index <- as.vector(1:length(data[,1]))[!(1:length(data[,1])%in%(tr.index))]
training <- data[tr.index,]
test <- data[-tr.index,] 
ppt.lda <- LDA.Tree(training[,1], training[,-1])

PDA.Tree(training[,1], training[,-1], lambda=.14)

table(training[,36])
#LDA in some cases the sample  Error in lda.default(x, grouping, ...) : 
 # variable 27 appears to be constant within groups
#PDA does not work with any lambda, why?
#How you get the cv for leukemia data if you have this problem because you use lda, pda

data <- NCI60
training <- train_fn(data[,1], .9)
#part of bootstrap_pp code
data[,-1] <- scale(data[,-1])
names(data)[1] <-"class"

n <- length(training)
class.id <- data.frame(id=1:n, class=data[training,"class"])
dat.train <- data[training,]

index.boot <- unlist(plyr::dlply(class.id, plyr::.(class), 
                   function(x) sort(sample(x$id, replace=TRUE)) ))
names(index.boot) <- NULL 
pp.tree <- PPtree_split(PPmethod=index, size.p=.9, i.data=dat.train[index.boot,-1], 
                            i.class=dat.train[index.boot,1]) 
pp.tree <- PP.Tree(PPmethod=index, size.p=.9, i.data=dat.train[index.boot,-1], 
                       i.class=dat.train[index.boot,1]) 

pp.tree

#I have a problem in the way I select the variables or how I change it in pptree function for some data work but not for all
```


Profiling

``{r}
data1 <- iris[,5:1]

training <- train_fn(iris[,5], .9)
test <- as.vector(1:length(iris[,5]))[!(1:length(iris[,5])%in%(training))]
output <- bootstrap_pp(data1, scale=TRUE, size.p=.9, training=NULL, 
  strata=TRUE, ntree=50, index="LDA")
 
bag.t <- system.time(bagging_pp(data1,scale=TRUE, strata=TRUE, output, training, test))
boo.t <- system.time(bootstrap_pp(data1, scale=TRUE, size.p=.9, training=NULL, 
  strata=TRUE, ntree=50, index="LDA"))

pptree.sp.t <- system.time(PPtree_split("LDA", data1[training,1], 
  data1[training,2:5], size.p=0.9))

ptm <- proc.time()
b1 <- bagging_pp(data1, scale=TRUE, strata=TRUE, output, training, test)
proc.time() - ptm

ptm <- proc.time()
b2 <- bootstrap_pp(data1, scale=TRUE, size.p=.9, training=NULL, strata=TRUE, 
        ntree=50, index="LDA")
proc.time() - ptm

bl1 <- profr(
  b1<-bagging_pp(data1,scale=TRUE, strata=TRUE,output,training,test)
)
head(bl1, 10)

plot(bl1)

bl2 <- profr(
  b2 <- bootstrap_pp(data1, scale=TRUE, size.p=.9, training=NULL, strata=TRUE, 
          ntree=50,index="LDA")
)
head(bl2, 20)
plot(bl2)

ldat <- profr(
  lda <- LDA.Tree(iris[,5], iris[,-5])
)
head(ldat, 20)
plot(ldat)
```